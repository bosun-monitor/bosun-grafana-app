{"version":3,"sources":["../../src/datasource/query_ctrl.js"],"names":[],"mappings":"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","file":"query_ctrl.js","sourcesContent":["import {QueryCtrl} from 'app/plugins/sdk';\nimport './css/query-editor.css!'\n\nexport class BosunDatasourceQueryCtrl extends QueryCtrl {\n\n  constructor($scope, $injector, uiSegmentSrv) {\n    super($scope, $injector);\n    this.scope = $scope;\n    this.queryHelper = {};\n    this.uiSegmentSrv = uiSegmentSrv;\n    this.target.expandHelper = 0;\n    this.target.target = this.target.target || 'Bosun Query';\n    this.suggestMetrics = this.suggestMetrics.bind(this);\n    this.addSuggest = this.addSuggest.bind(this);\n    this.labelFromUnit = this.labelFromUnit.bind(this);\n    this.metricInfo = this.metricInfo.bind(this);\n    this.suggestQuery = this.suggestQuery.bind(this);\n    this.suggestTagValues = this.suggestTagValues.bind(this);\n    this.filterTypes = [\"Group By\", \"Filter\"]\n  }\n\n  suggestMetrics(metric, callback) {\n    return this.datasource._metricsStartWith(metric).then(callback);\n  }\n\n  metricInfo() {\n    return this.datasource._tagKeysForMetric(this.queryHelper.metric).then((tagKeys) => {\n      this.datasource.q.all(_.map(tagKeys, (tagKey) => {\n        return this.datasource._tagValuesForMetricAndTagKey(this.queryHelper.metric, tagKey).then((tagValues) => {\n          return { key: tagKey, value: tagValues }\n        })\n      })\n      ).then((tagKeysToValues) => {\n        tagKeysToValues = _.each(tagKeysToValues, (v) => { v.filterType = \"Group By\" })\n        this.queryHelper.tagKeysToValues = tagKeysToValues;\n      })\n    }).then(() => this.datasource._metricMetadata(this.queryHelper.metric).then((metadata) => {\n      this.queryHelper.rate = metadata.Rate;\n      this.queryHelper.unit = metadata.Unit;\n      this.queryHelper.desc = metadata.Desc;\n    })).then(() => this.suggestQuery());\n  }\n\n  // Expects that getTags has been called\n  suggestTagValues(key, callback) {\n    return this.queryHelper.tagKeysToValues[key].then(callback)\n  }\n\n  labelFromUnit() {\n    if (this.panelCtrl.panel.type === \"graph\") {\n      this.panelCtrl.panel.yaxes[0].label = this.queryHelper.unit;\n    }\n    if (this.panelCtrl.panel.type === \"singlestat\") {\n      this.panelCtrl.panel.postfix = \" \" + this.queryHelper.unit;\n    }\n  }\n\n  suggestQuery() {\n    var metric = this.queryHelper.metric || \"metric.goes.here\";\n    var selectedGroupByTags = [];\n    var selectedFilterTags = [];\n    _.each(this.queryHelper.tagKeysToValues, (v) => {\n      if (v.selectedValue && v.selectedValue != \"\") {\n        if (v.filterType === this.filterTypes[0]) {\n          selectedGroupByTags.push(v.key + \"=\" + v.selectedValue);\n        }\n        if (v.filterType === this.filterTypes[1]) {\n          selectedFilterTags.push(v.key + \"=\" + v.selectedValue);\n        }\n      }\n    }, this);\n    var rate = \"\";\n    if (this.queryHelper.rate && this.queryHelper.rate == \"counter\") {\n      rate = \"rate{counter,,1}:\"\n    }\n    this.queryHelper.suggestedQuery = \"q(\\\"avg:$ds-avg:\" + rate + metric + \"{\" + selectedGroupByTags.join(\",\") + \"}\" + \"{\" + selectedFilterTags.join(\",\") + \"}\" + \"\\\", \\\"$start\\\", \\\"\\\")\"\n  }\n\n  onChangeInternal() {\n    this.panelCtrl.refresh(); // Asks the panel to refresh data.\n  }\n\n  addSuggest() {\n    if (this.target.expr) {\n      this.target.expr += \"\\n\" + this.queryHelper.suggestedQuery;\n    } else {\n      this.target.expr = this.queryHelper.suggestedQuery;\n    }\n  }\n}\n\nBosunDatasourceQueryCtrl.templateUrl = 'partials/query.editor.html';\n"]}