{"version":3,"sources":["../../src/datasource/query_ctrl.js"],"names":[],"mappings":"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","file":"query_ctrl.js","sourcesContent":["import {QueryCtrl} from 'app/plugins/sdk';\nimport './css/query-editor.css!'\n\nexport class BosunDatasourceQueryCtrl extends QueryCtrl {\n\n  constructor($scope, $injector, uiSegmentSrv) {\n    super($scope, $injector);\n    this.scope = $scope;\n    this.queryHelper = {};\n    this.uiSegmentSrv = uiSegmentSrv;\n    this.target.expandHelper = 0;\n    this.target.target = this.target.target || 'Bosun Query';\n    this.suggestMetrics = this.suggestMetrics.bind(this);\n    this.addSuggest = this.addSuggest.bind(this);\n    this.labelFromUnit = this.labelFromUnit.bind(this);\n    this.metricInfo = this.metricInfo.bind(this);\n    this.suggestQuery = this.suggestQuery.bind(this);\n    this.suggestTagValues = this.suggestTagValues.bind(this);\n    this.filterTypes = [\"Group By\", \"Filter\"]\n  }\n\n  suggestMetrics(metric, callback) {\n    return this.datasource._metricsStartWith(metric).then(callback);\n  }\n\n  metricInfo() {\n    return this.datasource._tagKeysForMetric(this.queryHelper.metric).then((tagKeys) => {\n      this.datasource.q.all(_.map(tagKeys, (tagKey) => {\n        return this.datasource._tagValuesForMetricAndTagKey(this.queryHelper.metric, tagKey).then((tagValues) => {\n          return { key: tagKey, value: tagValues }\n        })\n      })\n      ).then((tagKeysToValues) => {\n        tagKeysToValues = _.each(tagKeysToValues, (v) => { v.filterType = \"Group By\" })\n        this.queryHelper.tagKeysToValues = tagKeysToValues;\n      })\n    }).then(() => this.datasource._metricMetadata(this.queryHelper.metric).then((metadata) => {\n      this.queryHelper.rate = metadata.Rate;\n      this.queryHelper.unit = metadata.Unit;\n      this.queryHelper.desc = metadata.Desc;\n    })).then(() => this.suggestQuery());\n  }\n\n  // Expects that getTags has been called\n  suggestTagValues(key, callback) {\n    return this.queryHelper.tagKeysToValues[key].then(callback)\n  }\n\n  labelFromUnit() {\n    if (this.panelCtrl.panel.type === \"graph\") {\n      this.panelCtrl.panel.yaxes[0].label = this.queryHelper.unit;\n    }\n    if (this.panelCtrl.panel.type === \"singlestat\") {\n      this.panelCtrl.panel.postfix = \" \" + this.queryHelper.unit;\n    }\n  }\n\n  suggestQuery() {\n    var metric = this.queryHelper.metric || \"metric.goes.here\";\n    var selectedGroupByTags = [];\n    var selectedFilterTags = [];\n    _.each(this.queryHelper.tagKeysToValues, (v) => {\n      if (v.selectedValue && v.selectedValue != \"\") {\n        if (v.filterType === this.filterTypes[0]) {\n          selectedGroupByTags.push(v.key + \"=\" + v.selectedValue);\n        }\n        if (v.filterType === this.filterTypes[1]) {\n          selectedFilterTags.push(v.key + \"=\" + v.selectedValue);\n        }\n      }\n    }, this);\n    var rate = \"\";\n    if (this.queryHelper.rate && this.queryHelper.rate == \"counter\") {\n      rate = \"rate{counter,,1}:\"\n    }\n    this.queryHelper.suggestedQuery = \"q(\\\"avg:$ds-avg:\" + rate + metric + \"{\" + selectedGroupByTags.join(\",\") + \"}\" + \"{\" + selectedFilterTags.join(\",\") + \"}\" + \"\\\", \\\"$start\\\", \\\"\\\")\"\n  }\n\n  onChangeInternal() {\n    this.panelCtrl.refresh(); // Asks the panel to refresh data.\n  }\n\n  addSuggest() {\n    if (this.target.expr) {\n      this.target.expr += \"\\n\" + this.queryHelper.suggestedQuery;\n    } else {\n      this.target.expr = this.queryHelper.suggestedQuery;\n    }\n  }\n}\n\nBosunDatasourceQueryCtrl.templateUrl = 'datasource/partials/query.editor.html';\n"]}